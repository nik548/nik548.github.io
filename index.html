<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>100 Reasons I Love You</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg,#ffe4e8 0%,#fff0f5 100%);
      position: relative;
      color: #333;
      overflow: hidden;
    }

    /* Corner decorations */
    .corner {
      position: absolute;
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
    }
    .corner svg {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 0 5px rgba(214,51,108,0.6));
      animation: pulse 4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }
    .corner.left { top: 10px; left: 10px; }
    .corner.right { top: 10px; right: 10px; transform: scaleX(-1); }

    /* Page grid layout */
    .page {
      flex: 1;
      display: grid;
      grid-template-columns: 33% 1fr;
      grid-template-rows: auto 1fr 25vh;
      grid-template-areas:
        "header header"
        "grid right"
        "preview right";
      gap: 20px;
      padding: 10px 20px;
      overflow: hidden;
    }

    /* Header */
    .header {
      grid-area: header;
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: 10px;
    }
    h1 {
      font-size: clamp(32px, 6vw, 64px);
      font-weight: 700;
      color: #d6336c;
      text-align: center;
      font-family: 'Dancing Script', cursive;
      margin: 0;
      line-height: 1;
    }

    /* Grid of seen reasons */
    .grid-container {
      grid-area: grid;
      display: flex;
      flex-direction: column;
      gap: 10px;
      overflow: hidden;
      min-width: 0;
    }
    .grid-title {
      font-weight: 600;
      color: #d6336c;
      text-align: center;
      font-size: 16px;
    }
    .grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 4px;
      overflow: auto;
    }
    .grid-item {
      aspect-ratio: 1/1;
      background: #f0e8f2;
      border-radius: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      cursor: default;
      font-weight: 600;
      color: #666;
      transition: transform .2s ease;
      position: relative;
    }
    .grid-item.seen {
      background: #a8e6a3;
      color: #1f4d2f;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.1);
      cursor: pointer;
    }
    .grid-item.seen:hover { transform: scale(1.05); }

    /* Preview at bottom-left */
    .preview {
      grid-area: preview;
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      padding: 10px 0 0 0;
      overflow: hidden;
      position: relative;
    }
    .preview-box {
      background: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(214,51,108,0.12);
      width: 100%;
      height: 100%;
      display: flex;
      gap: 20px;
      flex-direction: column;
      justify-content: flex-start;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      pointer-events: none;
    }
    .preview.visible .preview-box {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .preview-title {
      font-weight: 600;
      font-size: 18px;
      color: #8f3f78;
      margin-bottom: 6px;
    }
    .preview-content {
      background: #f9f0fb;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      line-height: 1.3;
      flex: 1;
      overflow: auto;
    }

    /* Right area: card + favorites */
    .right-area {
      grid-area: right;
      display: flex;
      gap: 30px;
      align-items: flex-start;
      overflow: hidden;
    }
    .card-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      min-width: 340px;
      justify-content: center;
    }
    .card {
      width: 100%;
      max-width: 360px;
      aspect-ratio: 16/11;
      border: 4px solid #ffccd5;
      border-radius: 15px;
      background: #fff;
      box-shadow: 0 6px 30px rgba(255,182,193,0.5);
      perspective: 1000px;
      cursor: pointer;
      position: relative;
    }
    .card-inner {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(0.25,1.5,0.5,1);
    }
    .card.flipped .card-inner {
      transform: rotateY(180deg);
    }
    .card-face {
      position:absolute;
      width:100%; height:100%;
      backface-visibility:hidden;
      border-radius:11px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:16px;
      font-size:16px;
    }
    .card-front {
      background:#ffccd5;
      color:#222;
      font-family:'Dancing Script', cursive;
      font-size:24px;
      font-weight:700;
      text-align:center;
      line-height:1.1;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .card-back {
      background:#ffe4e1;
      transform:rotateY(180deg);
      position:relative;
      padding-bottom:60px;
    }
    .reason-number {
      font-weight:600;
      font-size:14px;
      color:#8f3f78;
      margin-bottom:6px;
      text-align:center;
    }
    #reason-text {
      max-width:260px;
      text-align:center;
      font-size:18px;
      font-weight:500;
      color:#3a2a3a;
      margin:0 auto;
    }

    .heart {
      position:absolute;
      top:10px;
      right:10px;
      font-size:26px;
      cursor:pointer;
      transition: color .25s;
      color:#ccc;
      user-select:none;
    }
    .heart.hearted { color:#e63946; }

    .animal {
      position:absolute; bottom:10px; right:10px;
      width:60px; height:60px;
      animation: dance 1s infinite ease-in-out;
    }
    @keyframes dance {
      0%,100%{transform:translateY(0) rotate(-5deg);}
      50%{transform:translateY(-5px) rotate(5deg);}
    }
    .animal::before {
      content:''; position:absolute;
      width:60px; height:60px; border-radius:50%;
      background:inherit;
    }
    .animal::after {
      content:''; position:absolute;
      width:8px; height:8px; background:#000;
      border-radius:50%; top:20px; left:15px;
      box-shadow:20px 0 #000;
    }
    .animal.cat { background:#ffcccb; }
    .animal.cat .ear {
      position:absolute; width:15px; height:15px; background:#ffcccb;
      top:-10px; clip-path:polygon(50% 0%,0% 100%,100% 100%);
    }
    .animal.cat .ear.left { left:5px; }
    .animal.cat .ear.right { right:5px; }
    .animal.cat .whiskers {
      position:absolute; bottom:15px; width:40px; height:2px;
    }
    .animal.cat .whiskers::before,
    .animal.cat .whiskers::after {
      content:''; position:absolute; width:40px; height:2px; background:#000;
    }
    .animal.cat .whiskers::before { transform:rotate(10deg); }
    .animal.cat .whiskers::after  { transform:rotate(-10deg); }

    .animal.bunny { background:#f4f4f4; }
    .animal.bunny .ear {
      position:absolute; width:12px; height:30px; background:#f4f4f4;
      top:-30px; border-radius:50%;
    }
    .animal.bunny .ear.left { left:10px; }
    .animal.bunny .ear.right { right:10px; }
    .animal.bunny .blush {
      position:absolute; bottom:10px; left:8px;
      width:10px; height:10px; border-radius:50%;
      background:pink; box-shadow:34px 0 pink;
    }

    .animal.bear { background:#deb887; }
    .animal.bear .ear {
      position:absolute; width:14px; height:14px; background:#deb887;
      top:-8px; border-radius:50%;
    }
    .animal.bear .ear.left { left:8px; }
    .animal.bear .ear.right { right:8px; }
    .animal.bear .nose {
      position:absolute; top:30px; left:26px;
      width:10px; height:8px; border-radius:50%; background:#333;
    }

    /* Streak / progress box */
    .streak-box {
      margin-top: 6px;
      background: #fff;
      padding: 14px 18px;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(214,51,108,0.08);
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity .3s ease, transform .3s ease;
    }
    .streak-box.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .streak-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .streak-label {
      color: #d6336c;
      font-weight: 600;
      min-width: 80px;
    }
    .progress-bar {
      background: #f0e8f2;
      border-radius: 8px;
      width: 120px;
      height: 10px;
      margin-top: 4px;
      position: relative;
      overflow: hidden;
    }
    .progress-fill {
      background: #a8e6a3;
      height: 100%;
      width: 0%;
      border-radius: 8px 0 0 8px;
      transition: width .4s ease;
    }

    /* Favorites leaderboard */
    .favorites {
      flex: 1;
      min-width: 220px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .favorites h2 {
      font-size:18px; margin:0; font-weight:600; color:#d6336c; text-align:center;
    }
    .fav-list {
      background:#fff;
      border:2px solid #ffccd5;
      border-radius:12px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:0 4px 16px rgba(214,51,108,0.08);
      flex:1;
      overflow:auto;
    }
    .fav-item {
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      background:#fdf4f9;
      border-radius:8px;
      position: relative;
      font-size:14px;
    }
    .fav-rank {
      font-weight:700;
      width:20px;
      text-align:center;
      color:#d6336c;
    }
    .fav-text {
      flex:1;
      overflow:hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .fav-controls {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .fav-controls button {
      background:none;
      border:none;
      cursor:pointer;
      padding:2px;
      font-size:14px;
      line-height:1;
      color:#8f3f78;
    }
    .fav-controls button:hover { color:#d6336c; }
    .remove-fav {
      position:absolute;
      top:4px; right:4px;
      background: transparent;
      border:none;
      cursor:pointer;
      font-size:14px;
      color:#999;
    }

    /* Countdown */
    #countdown {
      font-size:20px;
      text-align:center;
      background: rgba(255,255,255,0.9);
      padding:10px 14px;
      border-radius:10px;
      margin: 6px auto;
      max-width: 600px;
      align-self: center;
      font-weight:500;
      color:#444;
    }

    @media (max-width: 1100px) {
      .page { grid-template-columns: 1fr; grid-template-rows: auto auto 1fr 25vh; grid-template-areas: "header" "right" "grid" "preview"; }
      .right-area { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="corner left">
    <svg viewBox="0 0 64 64" aria-hidden="true">
      <path d="M32 58s-26-15.5-26-34c0-9.4 7.6-17 17-17 6.9 0 12.9 4 15 9.7C40.1 11 46.1 7 53 7c9.4 0 17 7.6 17 17 0 18.5-26 34-26 34z" fill="none" stroke="#d6336c" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="corner right">
    <svg viewBox="0 0 64 64" aria-hidden="true">
      <path d="M32 58s-26-15.5-26-34c0-9.4 7.6-17 17-17 6.9 0 12.9 4 15 9.7C40.1 11 46.1 7 53 7c9.4 0 17 7.6 17 17 0 18.5-26 34-26 34z" fill="none" stroke="#d6336c" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>

  <div class="page">
    <!-- Header -->
    <div class="header">
      <h1>100 Reasons I Love You</h1>
    </div>

    <!-- Grid -->
    <div class="grid-container">
      <div class="grid-title">Seen Reasons</div>
      <div class="grid" id="grid"></div>
    </div>

    <!-- Right: card + favorites + streak -->
    <div class="right-area">
      <div class="card-wrapper">
        <div class="card" id="card">
          <div class="card-inner">
            <div class="card-face card-front" id="card-front">
              Click here for today’s reason
            </div>
            <div class="card-face card-back" id="card-back">
              <div class="heart" id="heart">❤</div>
              <div class="reason-number" id="reason-number">Reason #--</div>
              <div id="reason-text"></div>
              <div id="animal" class="animal"></div>
            </div>
          </div>
        </div>
        <div class="streak-box" id="streak-box">
          <div class="streak-row">
            <div class="streak-label">💖 Love streak:</div>
            <div><strong><span id="love-streak-count">0</span> day<span id="streak-s-plural">s</span></strong></div>
          </div>
          <div class="streak-row">
            <div class="streak-label">👀 Seen:</div>
            <div>
              <strong><span id="seen-count">0</span>/100</strong>
              <div class="progress-bar">
                <div class="progress-fill" id="seen-progress"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="favorites">
        <h2>Favorites</h2>
        <div class="fav-list" id="fav-list"></div>
      </div>
    </div>

    <!-- Preview (bottom-left) -->
    <div class="preview" id="preview">
      <div class="preview-box">
        <div class="preview-section">
          <div class="preview-title" id="preview-title"></div>
          <div class="preview-content" id="preview-content"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Countdown -->
  <div id="countdown"></div>

  <script>
    // === Keys & constants ===
    const NUM_REASONS = 100;
    const SHUFFLED_ORDER_KEY = 'shuffledOrder';
    const SHUFFLED_PTR_KEY = 'shuffledPointer';
    const TODAY_IDX_KEY = 'todayReasonIndex';
    const EXPIRY_KEY = 'todayReasonExpiry';
    const SEEN_KEY = 'seenReasons';
    const FAVORITES_KEY = 'favoriteReasons';

    // Placeholder reasons (replace later)
    const reasons = Array.from({length: NUM_REASONS}, (_, i) => `Reason content for #${i+1}`);

    // Shuffle helper
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function getNextResetTimeEST() {
      const now = new Date();
      const estOffset = -5 * 60;
      const nowUtc = now.getTime() + now.getTimezoneOffset() * 60000;
      const nowEst = new Date(nowUtc + estOffset * 60000);
      const nextReset = new Date(nowEst);
      nextReset.setHours(7,0,0,0);
      if (nowEst >= nextReset) nextReset.setDate(nextReset.getDate()+1);
      return new Date(nextReset.getTime() - estOffset * 60000 - now.getTimezoneOffset() * 60000);
    }

    // === State initialization ===
    let shuffledOrder = JSON.parse(localStorage.getItem(SHUFFLED_ORDER_KEY) || 'null');
    let shuffledPtr = parseInt(localStorage.getItem(SHUFFLED_PTR_KEY) || '0', 10);
    if (!shuffledOrder || !Array.isArray(shuffledOrder) || shuffledOrder.length !== NUM_REASONS) {
      shuffledOrder = shuffle([...Array(NUM_REASONS).keys()]);
      shuffledPtr = 0;
      localStorage.setItem(SHUFFLED_ORDER_KEY, JSON.stringify(shuffledOrder));
      localStorage.setItem(SHUFFLED_PTR_KEY, shuffledPtr);
    }

    const nextReset = getNextResetTimeEST();
    let todayIndex;
    const storedIdx = parseInt(localStorage.getItem(TODAY_IDX_KEY), 10);
    const storedExpiry = localStorage.getItem(EXPIRY_KEY);
    let seen = new Set(JSON.parse(localStorage.getItem(SEEN_KEY) || '[]'));
    let favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');

    const now = new Date();
    if (!isNaN(storedIdx) && storedExpiry && new Date(storedExpiry) > now) {
      todayIndex = storedIdx;
    } else {
      if (shuffledPtr >= NUM_REASONS) shuffledPtr = 0;
      todayIndex = shuffledOrder[shuffledPtr];
      shuffledPtr += 1;
      localStorage.setItem(SHUFFLED_PTR_KEY, shuffledPtr);
      localStorage.setItem(TODAY_IDX_KEY, todayIndex);
      localStorage.setItem(EXPIRY_KEY, nextReset);
      seen.add(todayIndex);
      localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seen)));
    }
    if (!seen.has(todayIndex)) {
      seen.add(todayIndex);
      localStorage.setItem(SEEN_KEY, JSON.stringify(Array.from(seen)));
    }

    // === DOM refs ===
    const gridEl = document.getElementById('grid');
    const previewEl = document.getElementById('preview');
    const previewTitle = document.getElementById('preview-title');
    const previewContent = document.getElementById('preview-content');
    const reasonTextEl = document.getElementById('reason-text');
    const reasonNumberEl = document.getElementById('reason-number');
    const cardEl = document.getElementById('card');
    const heartEl = document.getElementById('heart');
    const favListEl = document.getElementById('fav-list');
    const countdownEl = document.getElementById('countdown');

    // Track which preview is open
    let currentPreview = null;

    // === Confetti ===
    function launchConfetti() {
      const colors = ['#ffb3c1', '#ffccd5', '#d6336c', '#ffe4e8', '#f8c8e0'];
      const count = 40;
      const container = document.createElement('div');
      container.style.position = 'fixed';
      container.style.top = '0';
      container.style.left = '0';
      container.style.width = '100%';
      container.style.height = '100%';
      container.style.pointerEvents = 'none';
      container.style.overflow = 'visible';
      container.style.zIndex = 1000;
      document.body.appendChild(container);

      const originX = window.innerWidth / 2;
      const originY = window.innerHeight / 3;

      for (let i = 0; i < count; i++) {
        const piece = document.createElement('div');
        const size = 6 + Math.random() * 8;
        piece.style.width = `${size}px`;
        piece.style.height = `${size * 0.6}px`;
        piece.style.background = colors[Math.floor(Math.random() * colors.length)];
        piece.style.position = 'absolute';
        piece.style.top = `${originY}px`;
        piece.style.left = `${originX}px`;
        piece.style.borderRadius = '3px';
        piece.style.opacity = '1';
        piece.style.transformOrigin = 'center';
        container.appendChild(piece);

        const deltaX = (Math.random() - 0.5) * 200;
        const deltaY = 150 + Math.random() * 100;
        const rotateStart = Math.random() * 360;
        const rotateEnd = rotateStart + (Math.random() > 0.5 ? 360 : -360);
        const duration = 1200 + Math.random() * 600;

        piece.animate([
          {
            transform: `translate(0px, 0px) rotate(${rotateStart}deg) scale(1)`,
            opacity: 1
          },
          {
            transform: `translate(${deltaX}px, ${deltaY}px) rotate(${rotateEnd}deg) scale(0.8)`,
            opacity: 0
          }
        ], {
          duration: duration,
          easing: 'cubic-bezier(0.25,0.46,0.45,0.94)',
          fill: 'forwards'
        });

        setTimeout(() => {
          piece.remove();
        }, duration + 100);
      }
      setTimeout(() => {
        container.remove();
      }, 2200);
    }

    // --- Streak logic ---
    function getLocalDateKey(d) {
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    function updateStreakUI() {
      const todayKey = getLocalDateKey(new Date());
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayKey = getLocalDateKey(yesterday);

      const lastKey = localStorage.getItem('loveStreakLastVisit');
      const storedStreak = parseInt(localStorage.getItem('loveStreakCount') || '0', 10);
      let newStreak = storedStreak;

      if (lastKey === todayKey) {
        // no change
      } else {
        if (lastKey === yesterdayKey) {
          newStreak = storedStreak + 1;
        } else {
          newStreak = 1;
        }
        localStorage.setItem('loveStreakCount', newStreak);
        localStorage.setItem('loveStreakLastVisit', todayKey);
      }

      if (newStreak !== storedStreak && newStreak > 0 && newStreak % 10 === 0) {
        launchConfetti();
      }

      document.getElementById('love-streak-count').textContent = newStreak;
      document.getElementById('streak-s-plural').textContent = newStreak === 1 ? '' : 's';

      const seenCount = typeof seen !== 'undefined' ? seen.size : 0;
      document.getElementById('seen-count').textContent = seenCount;
      const pct = Math.min(100, Math.round((seenCount / NUM_REASONS) * 100));
      document.getElementById('seen-progress').style.width = `${pct}%`;

      document.getElementById('streak-box').classList.add('visible');
    }

    // === Rendering ===
    function renderGrid() {
      gridEl.innerHTML = '';
      for (let i = 0; i < NUM_REASONS; i++) {
        const item = document.createElement('div');
        item.className = 'grid-item';
        item.dataset.index = i;
        item.textContent = i + 1;
        if (seen.has(i)) {
          item.classList.add('seen');
          item.addEventListener('click', () => togglePreview(i));
        }
        gridEl.appendChild(item);
      }
    }

    function togglePreview(idx) {
      if (currentPreview === idx) {
        // hide
        currentPreview = null;
        previewEl.classList.remove('visible');
        setTimeout(() => {
          previewTitle.textContent = '';
          previewContent.textContent = '';
        }, 250);
      } else {
        currentPreview = idx;
        previewTitle.textContent = `Reason #${idx+1}`;
        previewContent.textContent = reasons[idx];
        previewEl.classList.add('visible');
      }
    }

    function updateCardBack() {
      reasonTextEl.textContent = reasons[todayIndex];
      reasonNumberEl.textContent = `Reason #${todayIndex + 1}`;
      const animalEl = document.getElementById('animal');
      const animalsArr = ['cat','bunny','bear'];
      const choice = animalsArr[Math.floor(Math.random()*animalsArr.length)];
      animalEl.className = `animal ${choice}`;
      animalEl.innerHTML = `
        <div class="ear left"></div>
        <div class="ear right"></div>
        ${choice === 'cat' ? '<div class="whiskers"></div>' : ''}
        ${choice === 'bunny' ? '<div class="blush"></div>' : ''}
        ${choice === 'bear' ? '<div class="nose"></div>' : ''}
      `;
      if (favorites.includes(todayIndex)) heartEl.classList.add('hearted');
      else heartEl.classList.remove('hearted');
    }

    function renderFavorites() {
      favListEl.innerHTML = '';
      favorites.slice(0,5).forEach((idx, position) => {
        const item = document.createElement('div');
        item.className = 'fav-item';
        const rank = document.createElement('div');
        rank.className = 'fav-rank';
        rank.textContent = position + 1;
        const text = document.createElement('div');
        text.className = 'fav-text';
        text.textContent = reasons[idx];
        const controls = document.createElement('div');
        controls.className = 'fav-controls';
        const up = document.createElement('button');
        up.innerHTML = '▲';
        up.title = 'Move up';
        up.disabled = position === 0;
        up.addEventListener('click', () => {
          if (position > 0) {
            [favorites[position - 1], favorites[position]] = [favorites[position], favorites[position - 1]];
            persistFavorites();
            renderFavorites();
          }
        });
        const down = document.createElement('button');
        down.innerHTML = '▼';
        down.title = 'Move down';
        down.disabled = position === favorites.length -1;
        down.addEventListener('click', () => {
          if (position < favorites.length -1) {
            [favorites[position + 1], favorites[position]] = [favorites[position], favorites[position + 1]];
            persistFavorites();
            renderFavorites();
          }
        });
        controls.appendChild(up);
        controls.appendChild(down);
        const remove = document.createElement('button');
        remove.className = 'remove-fav';
        remove.innerHTML = '×';
        remove.title = 'Remove';
        remove.addEventListener('click', () => {
          favorites = favorites.filter(f => f !== idx);
          persistFavorites();
          renderFavorites();
          updateCardBack();
        });

        item.appendChild(rank);
        item.appendChild(text);
        item.appendChild(controls);
        item.appendChild(remove);
        favListEl.appendChild(item);
      });
    }

    function persistFavorites() {
      favorites = Array.from(new Set(favorites)).slice(0,5);
      localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
    }

    function updateCountdown() {
      const now = new Date();
      const diff = nextReset - now;
      if (diff <= 0) location.reload();
      const hh = String(Math.floor(diff / 3600000)).padStart(2,'0');
      const mm = String(Math.floor((diff % 3600000) / 60000)).padStart(2,'0');
      const ss = String(Math.floor((diff % 60000) / 1000)).padStart(2,'0');
      countdownEl.textContent = `Countdown to next card: ${hh}:${mm}:${ss}`;
    }

    // === Interactions ===
    cardEl.addEventListener('click', () => {
      cardEl.classList.toggle('flipped');
    });
    heartEl.addEventListener('click', e => {
      e.stopPropagation();
      const idx = todayIndex;
      const existing = favorites.indexOf(idx);
      if (existing !== -1) {
        favorites.splice(existing,1);
      } else {
        if (favorites.length >= 5) {
          alert('You can only favorite up to 5 reasons. Remove one first.');
          return;
        }
        favorites.push(idx);
      }
      persistFavorites();
      renderFavorites();
      updateCardBack();
    });

    // === Init ===
    renderGrid();
    updateCardBack();
    renderFavorites();
    updateStreakUI();
    updateCountdown();
    setInterval(updateCountdown, 1000);
    // do NOT auto-open preview; it appears only on first click of a seen square
  </script>
</body>
</html>
